# Load variables from .env file
include .env
export $(shell sed 's/=.*//' .env)

CONNECTOR_DIR = connectors

.PHONY: connectors up register clean

# 1. Generate all connector JSON files from *.template
connectors:
	@echo "Generating connector files from templates..."
	@for f in $(CONNECTOR_DIR)/*.json.template; do \
		envsubst < $$f > $${f%.template}; \
		echo "  created: $${f%.template}"; \
	done

# 2. Start docker-compose after generating connectors
up: connectors
	docker compose up -d

# 3. Register all connector JSONs via curl
register: connectors
	@for f in $(CONNECTOR_DIR)/*.json; do \
		echo "Registering $$f..."; \
		curl -s -X POST -H "Content-Type: application/json" \
			--data @$$f http://localhost:8083/connectors | jq .; \
	done

# 4. Clean generated files
clean:
	rm -f $(CONNECTOR_DIR)/*.json